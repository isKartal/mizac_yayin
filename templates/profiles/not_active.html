{% extends 'base.html' %}
{% load static %}

{% block title %}MİZAÇLAR | Önerilerim{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/profiles.css' %}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="profile-settings-container">
        <!-- Header Section -->
        <div class="profile-header">
            <h1>Size Özel Önerilerimiz</h1>
        </div>

        <!-- Main Content Grid -->
        <div class="profile-card">
            <!-- Content Navigation - Kategori Geçişi İçin -->
            <div class="content-navigation">
                <div class="nav-buttons">
                    <button class="nav-button" id="prevCategory"><i class="fas fa-chevron-left"></i></button>
                    <span class="nav-title" id="categoryTitle">Tüm İçerikler</span>
                    <button class="nav-button" id="nextCategory"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>

            <!-- Content Grid -->
            <div class="content-grid" id="contentGrid">
                {% for content in contents %}
                <div class="content-card" data-content-id="{{ content.id }}" data-category="{{ content.category.id }}">
                    {% if content.image %}
                    <div class="content-image" style="background-image: url('{{ content.image.url }}')"></div>
                    {% else %}
                    <div class="content-image placeholder-image">
                        <i class="fas fa-book-open"></i>
                    </div>
                    {% endif %}
                    <div class="content-title">{{ content.title }}</div>
                    <div class="interaction-buttons">
                        <button class="interaction-button like-button {% if content.user_interactions.liked %}liked{% endif %}" 
                                data-content-id="{{ content.id }}">
                            <i class="{% if content.user_interactions.liked %}fas{% else %}far{% endif %} fa-heart"></i>
                            <span class="like-count">{{ content.like_count }}</span>
                        </button>
                        <button class="interaction-button save-button {% if content.user_interactions.saved %}saved{% endif %}" 
                                data-content-id="{{ content.id }}">
                            <i class="{% if content.user_interactions.saved %}fas{% else %}far{% endif %} fa-bookmark"></i>
                            <span class="save-text">{% if content.user_interactions.saved %}Kaydedildi{% else %}Kaydet{% endif %}</span>
                        </button>
                    </div>
                </div>
                {% empty %}
                <div class="empty-content">
                    <p>Henüz öneri içeriği eklenmemiştir.</p>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination Dots - Sayfa Geçişi İçin -->
            <div class="pagination-dots" id="paginationDots">
                <!-- Sayfalama noktaları JS ile dinamik olarak oluşturulacak -->
                <i class="fas fa-arrow-right" id="nextPageArrow"></i>
            </div>
        </div>
    </div>
</div>

<!-- Content Detail Modal -->
<div class="content-modal" id="contentModal">
    <div class="modal-container">
        <div class="modal-header">
            <div class="modal-navigation">
                <button class="modal-nav-button" id="prevModalContent"><i class="fas fa-chevron-left"></i></button>
            </div>
            <div class="modal-content-area">
                <h2 id="modalTitle"></h2>
            </div>
            <div class="modal-close">
                <button class="modal-close-button" id="closeModal"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div class="modal-body">
            <div id="modalContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
        <div class="modal-footer">
            <div class="modal-interactions">
                <button class="modal-interaction-btn modal-like-btn" id="modalLikeBtn">
                    <i class="far fa-heart"></i> Beğen
                </button>
                <button class="modal-interaction-btn modal-save-btn" id="modalSaveBtn">
                    <i class="far fa-bookmark"></i> Kaydet
                </button>
            </div>
            <div class="modal-pagination" id="modalPagination">
                <!-- Modal sayfalama noktaları JS ile dinamik olarak oluşturulacak -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tüm içerik kartları
    const contentCards = document.querySelectorAll('.content-card');
    const itemsPerPage = 6; // Her sayfada 6 içerik (3x2 grid)
    
    // Kategori değişkenleri
    const categoryTitle = document.getElementById('categoryTitle');
    const prevCategoryBtn = document.getElementById('prevCategory');
    const nextCategoryBtn = document.getElementById('nextCategory');
    
    // Benzersiz kategorileri topla
    const categories = [];
    const categoryNames = {};
    
    // Tüm kategorileri topla
    {% for category in categories %}
        categories.push("{{ category.id }}");
        categoryNames["{{ category.id }}"] = "{{ category.name }}";
    {% endfor %}
    
    // Eğer kategori yoksa, "Tüm İçerikler" kategorisini ekle
    if (categories.length === 0) {
        categories.push("all");
        categoryNames["all"] = "Tüm İçerikler";
    }
    
    let currentCategoryIndex = 0;
    let currentPage = 0;
    let currentModalContentId = null;
    
    // Sayfalama değişkenleri
    let visibleCards = [];
    let totalPages = 0;
    
    // İçerikleri kategoriye göre filtrele
    function filterByCategory(categoryId) {
        // Tüm kartları sıfırla
        contentCards.forEach(card => {
            card.style.display = 'none';
        });
        
        // Geçerli kategoriyi güncelle
        if (categoryId === "all") {
            // "Tüm İçerikler" kategorisi için tüm kartları göster
            visibleCards = [...contentCards];
            categoryTitle.textContent = categoryNames["all"];
        } else {
            // Belirli kategoriye ait kartları filtrele
            visibleCards = Array.from(contentCards).filter(card => 
                card.getAttribute('data-category') === categoryId
            );
            categoryTitle.textContent = categoryNames[categoryId];
        }
        
        // Toplam sayfa sayısını güncelle
        totalPages = Math.ceil(visibleCards.length / itemsPerPage);
        
        // Sayfalama noktalarını güncelle
        updatePaginationDots();
        
        // İlk sayfayı göster
        showPage(0);
    }
    
    // Sayfalama noktalarını oluştur/güncelle
    function updatePaginationDots() {
        const paginationDots = document.getElementById('paginationDots');
        if (!paginationDots) return;
        
        // Mevcut noktaları temizle
        while (paginationDots.firstChild) {
            if (paginationDots.firstChild.id === 'nextPageArrow') {
                break;
            }
            paginationDots.removeChild(paginationDots.firstChild);
        }
        
        // Yeni noktaları ekle
        const nextArrow = document.getElementById('nextPageArrow');
        for (let i = 0; i < totalPages; i++) {
            const dot = document.createElement('span');
            dot.classList.add('dot');
            if (i === 0) dot.classList.add('active');
            dot.dataset.page = i;
            
            // Tıklama olayı ekle
            dot.addEventListener('click', function() {
                showPage(parseInt(this.dataset.page));
            });
            
            // nextArrow'dan önce ekle
            if (nextArrow) {
                paginationDots.insertBefore(dot, nextArrow);
            } else {
                paginationDots.appendChild(dot);
            }
        }
    }
    
    // Sayfa gösterme fonksiyonu
    function showPage(pageNum) {
        if (pageNum < 0 || pageNum >= totalPages) return;
        
        // Tüm kartları gizle
        visibleCards.forEach(card => {
            card.style.display = 'none';
        });
        
        // Geçerli sayfadaki kartları göster
        const start = pageNum * itemsPerPage;
        const end = Math.min(start + itemsPerPage, visibleCards.length);
        
        for (let i = start; i < end; i++) {
            if (visibleCards[i]) {
                visibleCards[i].style.display = '';
            }
        }
        
        // Aktif noktayı güncelle
        const dots = document.querySelectorAll('.pagination-dots .dot');
        dots.forEach((dot, index) => {
            dot.classList.toggle('active', index === pageNum);
        });
        
        currentPage = pageNum;
    }
    
    // Kategori geçişi
    function changeCategory(direction) {
        currentCategoryIndex = (currentCategoryIndex + direction + categories.length) % categories.length;
        filterByCategory(categories[currentCategoryIndex]);
    }
    
    // Kategori butonlarına olay ekle
    if (prevCategoryBtn) {
        prevCategoryBtn.addEventListener('click', function() {
            changeCategory(-1);
        });
    }
    
    if (nextCategoryBtn) {
        nextCategoryBtn.addEventListener('click', function() {
            changeCategory(1);
        });
    }
    
    // Sayfalama butonuna olay ekle
    const nextPageArrow = document.getElementById('nextPageArrow');
    if (nextPageArrow) {
        nextPageArrow.addEventListener('click', function() {
            if (currentPage < totalPages - 1) {
                showPage(currentPage + 1);
            } else {
                showPage(0); // Son sayfadaysa ilk sayfaya git
            }
        });
    }
    
    // Modal işlemleri
    const modal = document.getElementById('contentModal');
    const closeButton = document.getElementById('closeModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');
    const prevModalContent = document.getElementById('prevModalContent');
    const modalLikeBtn = document.getElementById('modalLikeBtn');
    const modalSaveBtn = document.getElementById('modalSaveBtn');
    
    // Beğenme işlevi
    function toggleLike(contentId, button) {
        fetch(`/profiles/content/${contentId}/toggle_like/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Tüm kartlarda ve modalda güncelleme yap
                updateLikeButtons(contentId, data.liked);
                
                // Beğeni sayısını güncelle
                const likeCountElements = document.querySelectorAll(`.like-button[data-content-id="${contentId}"] .like-count`);
                likeCountElements.forEach(elem => {
                    elem.textContent = data.like_count || 0;
                });
            }
        })
        .catch(error => console.error('Error:', error));
    }
    
    // Kaydetme işlevi
    function toggleSave(contentId, button) {
        fetch(`/profiles/content/${contentId}/toggle_save/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Tüm kartlarda ve modalda güncelleme yap
                updateSaveButtons(contentId, data.saved);
            }
        })
        .catch(error => console.error('Error:', error));
    }
    
    // Beğenme butonlarını güncelle
    function updateLikeButtons(contentId, isLiked) {
        // Kart üzerindeki beğenme butonunu güncelle
        const likeButtons = document.querySelectorAll(`.like-button[data-content-id="${contentId}"]`);
        likeButtons.forEach(btn => {
            const icon = btn.querySelector('i');
            btn.classList.toggle('liked', isLiked);
            
            if (isLiked) {
                icon.classList.remove('far');
                icon.classList.add('fas');
            } else {
                icon.classList.remove('fas');
                icon.classList.add('far');
            }
        });
        
        // Modal beğenme butonunu güncelle (eğer gösteriliyorsa)
        if (currentModalContentId === contentId && modalLikeBtn) {
            const modalIcon = modalLikeBtn.querySelector('i');
            modalLikeBtn.classList.toggle('liked', isLiked);
            
            if (isLiked) {
                modalIcon.classList.remove('far');
                modalIcon.classList.add('fas');
                modalLikeBtn.innerHTML = `<i class="fas fa-heart"></i> Beğenildi`;
            } else {
                modalIcon.classList.remove('fas');
                modalIcon.classList.add('far');
                modalLikeBtn.innerHTML = `<i class="far fa-heart"></i> Beğen`;
            }
        }
    }
    
    // Kaydetme butonlarını güncelle
    function updateSaveButtons(contentId, isSaved) {
        // Kart üzerindeki kaydetme butonunu güncelle
        const saveButtons = document.querySelectorAll(`.save-button[data-content-id="${contentId}"]`);
        saveButtons.forEach(btn => {
            const icon = btn.querySelector('i');
            const text = btn.querySelector('.save-text');
            btn.classList.toggle('saved', isSaved);
            
            if (isSaved) {
                icon.classList.remove('far');
                icon.classList.add('fas');
                if (text) text.textContent = 'Kaydedildi';
            } else {
                icon.classList.remove('fas');
                icon.classList.add('far');
                if (text) text.textContent = 'Kaydet';
            }
        });
        
        // Modal kaydetme butonunu güncelle (eğer gösteriliyorsa)
        if (currentModalContentId === contentId && modalSaveBtn) {
            const modalIcon = modalSaveBtn.querySelector('i');
            modalSaveBtn.classList.toggle('saved', isSaved);
            
            if (isSaved) {
                modalIcon.classList.remove('far');
                modalIcon.classList.add('fas');
                modalSaveBtn.innerHTML = `<i class="fas fa-bookmark"></i> Kaydedildi`;
            } else {
                modalIcon.classList.remove('fas');
                modalIcon.classList.add('far');
                modalSaveBtn.innerHTML = `<i class="far fa-bookmark"></i> Kaydet`;
            }
        }
    }
    
    // Beğen butonlarına tıklama olayı ekle
    document.querySelectorAll('.like-button').forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation(); // Kart tıklamasını engelle
            const contentId = this.getAttribute('data-content-id');
            toggleLike(contentId, this);
        });
    });
    
    // Kaydet butonlarına tıklama olayı ekle
    document.querySelectorAll('.save-button').forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation(); // Kart tıklamasını engelle
            const contentId = this.getAttribute('data-content-id');
            toggleSave(contentId, this);
        });
    });
    
    // İçerik kartlarına tıklama olayları
    contentCards.forEach((card, index) => {
        card.addEventListener('click', function() {
            const contentId = this.getAttribute('data-content-id');
            currentModalContentId = contentId;
            
            // İçeriği AJAX ile çek
            fetch(`/profiles/content/${contentId}/detail/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('İçerik yüklenirken bir hata oluştu');
                    }
                    return response.json();
                })
                .then(data => {
                    // Modal içeriğini doldur
                    modalTitle.textContent = data.title;
                    modalContent.innerHTML = data.content;
                    
                    // Modal beğenme/kaydetme butonlarını güncelle
                    if (modalLikeBtn) {
                        updateLikeButtons(contentId, data.liked);
                    }
                    
                    if (modalSaveBtn) {
                        updateSaveButtons(contentId, data.saved);
                    }
                    
                    // Modal beğen butonuna olay ekle
                    if (modalLikeBtn) {
                        modalLikeBtn.onclick = function() {
                            toggleLike(contentId, this);
                        };
                    }
                    
                    // Modal kaydet butonuna olay ekle
                    if (modalSaveBtn) {
                        modalSaveBtn.onclick = function() {
                            toggleSave(contentId, this);
                        };
                    }
                    
                    // Modalı göster
                    modal.classList.add('active');
                    document.body.style.overflow = 'hidden'; // Arka planı kaydırmayı engelle
                })
                .catch(error => {
                    console.error('Hata:', error);
                    // Hata durumunda da modal açılsın, ancak hata mesajı gösterilsin
                    modalTitle.textContent = this.querySelector('.content-title').textContent;
                    modalContent.innerHTML = '<p>İçerik yüklenirken bir hata oluştu. Lütfen daha sonra tekrar deneyin.</p>';
                    modal.classList.add('active');
                    document.body.style.overflow = 'hidden';
                });
        });
    });
    
    // Modal kapatma olayı
    if (closeButton) {
        closeButton.addEventListener('click', function() {
            modal.classList.remove('active');
            document.body.style.overflow = ''; // Arka plan kaydırmayı tekrar etkinleştir
        });
    }
    
    // Modal dışına tıklama ile kapatma
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        });
    }
    
    // Modal içinde önceki/sonraki içeriğe geçiş
    if (prevModalContent) {
        prevModalContent.addEventListener('click', function() {
            // Modalda gösterilen içeriğin indexini bul
            const currentCardIndex = Array.from(visibleCards).findIndex(card => 
                card.getAttribute('data-content-id') === currentModalContentId
            );
            
            if (currentCardIndex === -1 || visibleCards.length <= 1) return;
            
            // Bir önceki içeriğe geç
            const prevIndex = (currentCardIndex - 1 + visibleCards.length) % visibleCards.length;
            const prevCard = visibleCards[prevIndex];
            const prevContentId = prevCard.getAttribute('data-content-id');
            currentModalContentId = prevContentId;
            
            // Yeni içeriği yükle
            fetch(`/profiles/content/${prevContentId}/detail/`)
                .then(response => response.json())
                .then(data => {
                    modalTitle.textContent = data.title;
                    modalContent.innerHTML = data.content;
                    
                    // Beğen/kaydet butonlarını güncelle
                    updateLikeButtons(prevContentId, data.liked);
                    updateSaveButtons(prevContentId, data.saved);
                    
                    // Modal butonlarına olay dinleyicileri güncelle
                    if (modalLikeBtn) {
                        modalLikeBtn.onclick = function() {
                            toggleLike(prevContentId, this);
                        };
                    }
                    
                    if (modalSaveBtn) {
                        modalSaveBtn.onclick = function() {
                            toggleSave(prevContentId, this);
                        };
                    }
                })
                .catch(error => {
                    console.error('Hata:', error);
                    modalContent.innerHTML = '<p>İçerik yüklenirken bir hata oluştu.</p>';
                });
        });
    }
    
    // CSRF token'ı almak için yardımcı fonksiyon
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Başlangıçta ilk kategoriyi göster
    filterByCategory(categories[0]);
});
</script>
{% endblock %}
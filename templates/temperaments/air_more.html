{% extends 'base.html' %}
{% load static %}

{% block title %}MİZAÇLAR - Hava Mizacı{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/temperaments.css' %}">
{% endblock %}

{% block content %}
<!-- Hava Mizacının Kişilik Bölümü -->
<section class="air-personality">
  <div class="container">
    <div class="temperament-header">
      <div class="element-badge air">Hava Mizacı</div>
    </div>
    
    <div class="air-personality-container">
      <!-- Sol: Metin ve Bilgi Kartları -->
      <div class="air-personality-text">
        <h1 class="temperament-title">Hava Mizacının Gücü</h1>
        <p class="air-personality-desc">
          Hava mizacına sahip bireyler, iletişime açık, analitik ve sosyal yönleri güçlü kişilerdir. Esnek düşünce yapıları sayesinde her ortamda uyum sağlar, farklı bakış açıları geliştirme ve analiz etme konusunda ustadırlar.
        </p>
        <div class="air-personality-cards">
          <div class="air-personality-card">
            <i class="fas fa-comments"></i>
            <h3>İletişim</h3>
            <p>Akıcı ve etkili konuşma yeteneği.</p>
          </div>
          <div class="air-personality-card">
            <i class="fas fa-brain"></i>
            <h3>Analitik</h3>
            <p>Farklı bakış açılarıyla derin düşünme.</p>
          </div>
          <div class="air-personality-card">
            <i class="fas fa-lightbulb"></i>
            <h3>Yaratıcılık</h3>
            <p>Yeni fikirler ve inovatif çözümler üretme.</p>
          </div>
        </div>
      </div>
      <!-- Sağ: Görsel Bölümü -->
      <div class="air-personality-image">
        <img src="{% static 'images/air-personality.jpg' %}" alt="Hava Mizacı">
      </div>
    </div>
</section>

<!-- Mizaç Önerileri Bölümü -->
<section class="temperament-suggestions">
  <div class="container">
    <div class="suggestions-header">
      <h2>{{ element_name }} Mizacı İçin Öneriler</h2>
      <p>Mizacınıza özel olarak seçilmiş, size en uygun içerikler</p>
    </div>
    
    <div class="suggestions-grid">
      {% for content in element_suggestions %}
        <div class="suggestion-card" data-content-id="{{ content.id }}">
          {% if content.image %}
            <div class="suggestion-image" style="background-image: url('{{ content.image.url }}')">
              <div class="suggestion-element {{ element_name|lower }}">{{ element_name }}</div>
              <div class="suggestion-category">{{ content.category.name }}</div>
            </div>
          {% else %}
            <div class="suggestion-image placeholder-image">
              <i class="fas fa-book-open"></i>
              <div class="suggestion-element {{ element_name|lower }}">{{ element_name }}</div>
              <div class="suggestion-category">{{ content.category.name }}</div>
            </div>
          {% endif %}
          
          <h3 class="suggestion-title">{{ content.title }}</h3>
          <p class="suggestion-description">{{ content.short_description|truncatechars:80 }}</p>
          
          <div class="suggestion-actions">
            <button class="suggestion-button like-button {% if content.is_liked %}liked{% endif %}" 
                    data-content-id="{{ content.id }}">
              <i class="{% if content.is_liked %}fas{% else %}far{% endif %} fa-heart"></i>
              <span class="like-count">{{ content.like_count }}</span>
            </button>
            <button class="suggestion-button read-more" data-content-id="{{ content.id }}">
              <i class="fas fa-book-reader"></i> Devamını Oku
            </button>
          </div>
        </div>
      {% empty %}
        <div class="empty-state">
          <div class="empty-icon"><i class="fas fa-inbox"></i></div>
          <p class="empty-text">{{ element_name }} mizacı için henüz öneri içeriği eklenmemiştir.</p>
        </div>
      {% endfor %}
    </div>
    
    <div class="suggestions-more">
      <a href="{% url 'my_suggestions' %}" class="more-link">
        Tüm Önerileri Görüntüle <i class="fas fa-arrow-right"></i>
      </a>
    </div>
  </div>
</section>

<!-- İçerik Detay Modalı -->
<div class="content-modal" id="contentModal">
  <div class="modal-container">
    <div class="modal-header">
      <button class="modal-nav-button" id="prevModalContent"><i class="fas fa-chevron-left"></i></button>
      <h2 id="modalTitle"></h2>
      <button class="modal-close-button" id="closeModal"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <div class="modal-category" id="modalCategory"></div>
      <div class="modal-content" id="modalContent">
        <!-- İçerik buraya yüklenecek -->
      </div>
    </div>
    <div class="modal-footer">
      <div class="modal-actions">
        <button class="modal-action-btn" id="modalLikeBtn">
          <i class="far fa-heart"></i> Beğen
        </button>
        <button class="modal-action-btn" id="modalSaveBtn">
          <i class="far fa-bookmark"></i> Kaydet
        </button>
      </div>
      <div class="modal-element" id="modalElement"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // IntersectionObserver: Tüm elementler için "appear" sınıfını ekle
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('appear');
        }
      });
    }, { threshold: 0.1 });
    
    // Hem mizaç kartlarını hem de öneri kartlarını gözlemle
    document.querySelectorAll('.air-personality-text, .air-personality-image, .suggestion-card').forEach(el => {
      observer.observe(el);
    });
    
    // Öneri kartlarına tıklama olayı ekle
    const suggestionCards = document.querySelectorAll('.suggestion-card');
    suggestionCards.forEach(card => {
      card.addEventListener('click', function(e) {
        if (!e.target.closest('.suggestion-button')) {
          const contentId = this.dataset.contentId;
          openContentModal(contentId);
        }
      });
    });
    
    // Beğenme butonlarına tıklama olayı ekle
    const likeButtons = document.querySelectorAll('.like-button');
    likeButtons.forEach(button => {
      button.addEventListener('click', function(e) {
        e.stopPropagation();
        const contentId = this.dataset.contentId;
        toggleLike(contentId, this);
      });
    });
    
    // Devamını Oku butonlarına tıklama olayı ekle
    const readMoreButtons = document.querySelectorAll('.read-more');
    readMoreButtons.forEach(button => {
      button.addEventListener('click', function(e) {
        e.stopPropagation();
        const contentId = this.dataset.contentId;
        openContentModal(contentId);
      });
    });
    
    // Modal kapat butonuna tıklama olayı ekle
    const closeModalBtn = document.getElementById('closeModal');
    if (closeModalBtn) {
      closeModalBtn.addEventListener('click', function() {
        const contentModal = document.getElementById('contentModal');
        contentModal.classList.remove('active');
        document.body.style.overflow = '';
      });
    }
    
    // Modal dışına tıklama ile kapatma
    const contentModal = document.getElementById('contentModal');
    if (contentModal) {
      contentModal.addEventListener('click', function(e) {
        if (e.target === contentModal) {
          contentModal.classList.remove('active');
          document.body.style.overflow = '';
        }
      });
    }
    
    // Modal butonlarına olay ekle
    const modalLikeBtn = document.getElementById('modalLikeBtn');
    if (modalLikeBtn) {
      modalLikeBtn.addEventListener('click', function() {
        const contentId = this.dataset.contentId;
        toggleLike(contentId, this);
      });
    }
    
    const modalSaveBtn = document.getElementById('modalSaveBtn');
    if (modalSaveBtn) {
      modalSaveBtn.addEventListener('click', function() {
        const contentId = this.dataset.contentId;
        toggleSave(contentId, this);
      });
    }
    
    // İçerik modalını açma fonksiyonu
    function openContentModal(contentId) {
      // İçeriği AJAX ile çek
      fetch(`/profiles/content/${contentId}/detail/`)
        .then(response => {
          if (!response.ok) {
            throw new Error('İçerik yüklenirken hata oluştu');
          }
          return response.json();
        })
        .then(data => {
          // Modal başlığını ayarla
          document.getElementById('modalTitle').textContent = data.title;
          
          // Kategori bilgisini göster
          document.getElementById('modalCategory').textContent = data.category;
          
          // İçeriği göster
          document.getElementById('modalContent').innerHTML = data.content;
          
          // Element bilgisini göster
          document.getElementById('modalElement').textContent = data.related_element;
          document.getElementById('modalElement').className = `modal-element ${data.related_element.toLowerCase()}`;
          
          // Beğenme durumunu güncelle
          const likeBtn = document.getElementById('modalLikeBtn');
          likeBtn.dataset.contentId = contentId;
          likeBtn.className = `modal-action-btn${data.liked ? ' liked' : ''}`;
          likeBtn.innerHTML = data.liked ? 
            '<i class="fas fa-heart"></i> Beğenildi' : 
            '<i class="far fa-heart"></i> Beğen';
          
          // Kaydetme durumunu güncelle
          const saveBtn = document.getElementById('modalSaveBtn');
          saveBtn.dataset.contentId = contentId;
          saveBtn.className = `modal-action-btn${data.saved ? ' saved' : ''}`;
          saveBtn.innerHTML = data.saved ? 
            '<i class="fas fa-bookmark"></i> Kaydedildi' : 
            '<i class="far fa-bookmark"></i> Kaydet';
          
          // Modalı göster
          document.getElementById('contentModal').classList.add('active');
          document.body.style.overflow = 'hidden';
        })
        .catch(error => {
          console.error('Hata:', error);
          alert('İçerik yüklenirken bir hata oluştu. Lütfen daha sonra tekrar deneyin.');
        });
    }
    
    // Beğenme işlevi
    function toggleLike(contentId, button) {
      fetch(`/profiles/content/${contentId}/toggle_like/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({})
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Beğenme durumunu güncelle
          updateLikeStatus(contentId, data.liked, data.like_count);
        }
      })
      .catch(error => console.error('Hata:', error));
    }
    
    // Kaydetme işlevi
    function toggleSave(contentId, button) {
      fetch(`/profiles/content/${contentId}/toggle_save/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({})
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Kaydetme durumunu güncelle
          updateSaveStatus(contentId, data.saved);
        }
      })
      .catch(error => console.error('Hata:', error));
    }
    
    // Beğenme durumunu güncelle
    function updateLikeStatus(contentId, isLiked, likeCount) {
      // Kart butonlarını güncelle
      const likeButtons = document.querySelectorAll(`.like-button[data-content-id="${contentId}"]`);
      likeButtons.forEach(btn => {
        btn.classList.toggle('liked', isLiked);
        const icon = btn.querySelector('i');
        icon.className = isLiked ? 'fas fa-heart' : 'far fa-heart';
        
        const countSpan = btn.querySelector('.like-count');
        if (countSpan) {
          countSpan.textContent = likeCount;
        }
      });
      
      // Modal butonunu güncelle
      const modalLikeBtn = document.getElementById('modalLikeBtn');
      if (modalLikeBtn && modalLikeBtn.dataset.contentId === contentId) {
        modalLikeBtn.classList.toggle('liked', isLiked);
        modalLikeBtn.innerHTML = isLiked ? 
          '<i class="fas fa-heart"></i> Beğenildi' : 
          '<i class="far fa-heart"></i> Beğen';
      }
    }
    
    // Kaydetme durumunu güncelle
    function updateSaveStatus(contentId, isSaved) {
      // Modal butonunu güncelle
      const modalSaveBtn = document.getElementById('modalSaveBtn');
      if (modalSaveBtn && modalSaveBtn.dataset.contentId === contentId) {
        modalSaveBtn.classList.toggle('saved', isSaved);
        modalSaveBtn.innerHTML = isSaved ? 
          '<i class="fas fa-bookmark"></i> Kaydedildi' : 
          '<i class="far fa-bookmark"></i> Kaydet';
      }
    }
    
    // CSRF token'ı almak için yardımcı fonksiyon
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  });
</script>
{% endblock %}